name: CI

on:
  push:
    branches:
      - main
    paths:
      - '*.cs'
      - '.github/workflows/**'
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build:
    name: Build
    env:
      NUPKG_MAJOR: 0.999
      # CODESIGN_PFX: ${{ secrets.CODESIGN_PFX }}
      APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
      APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}

    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v6
    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: |
          10.0.x
    - name: Test
      run: dotnet test ./generated/src/AppStoreConnect.Net.Test/AppStoreConnect.Net.Test.csproj -c Release --filter "FullyQualifiedName~AppsAppStoreVersionsGetToManyRelatedTest"
    # - name: Pack
    #   shell: pwsh
    #   run: |
    #     $VERSION="$env:NUPKG_MAJOR-ci$env:GITHUB_RUN_ID"
    #     if ($env:GITHUB_EVENT_NAME -eq "release") {
    #       $VERSION = $env:GITHUB_REF.Substring($env:GITHUB_REF.LastIndexOf('/') + 1)
    #     }
    #     echo "::set-output name=pkgverci::$VERSION"
        
    #     echo "::group::Packing NuGet package version $VERSION"
    #     New-Item -ItemType Directory -Force -Path .\artifacts
    #     dotnet pack --output ./artifacts --configuration Release -p:PackageId=AppStoreConnect.Bug -p:PackageVersion=$VERSION ./generated/src/AppStoreConnect.Net/AppStoreConnect.Net.csproj
    #     echo "::endgroup::"
    #     ls -la ./artifacts

    #     if ($env:CODESIGN_PFX -eq $null -or $env:CODESIGN_PFX -eq "") {
    #         echo "Code signing certificate not provided, skipping package signing."
    #         exit 0
    #     }
    #     $pfxPath = Join-Path -Path $pwd -ChildPath "codesigncert.pfx"
    #     [IO.File]::WriteAllBytes("$pfxPath", [System.Convert]::FromBase64String($env:CODESIGN_PFX))
    #     dotnet nuget sign .\artifacts\*.nupkg --certificate-path $pfxPath --timestamper http://timestamp.entrust.net/TSS/RFC3161sha2TS
        
    # - name: Artifacts
    #   uses: actions/upload-artifact@v6
    #   with:
    #     name: NuGet
    #     path: ./artifacts

  # publish:
  #   name: Publish
  #   permissions:
  #     id-token: write  # enable GitHub OIDC token issuance for this job
  #   needs: build
  #   runs-on: ubuntu-latest
  #   if: github.event_name == 'release'
  #   steps:
  #     - name: Download Artifacts
  #       uses: actions/download-artifact@v7
  #       with:
  #         name: NuGet
  #         path: ./NuGet
  #     - name: Setup .NET
  #       uses: actions/setup-dotnet@v5
  #       with:
  #         dotnet-version: '10.0.x'
  #     # Get a short-lived NuGet API key
  #     - name: NuGet login (OIDC â†’ temp API key)
  #       uses: NuGet/login@v1
  #       id: login
  #       with:
  #         user: hugebug4ever
  #     # https://www.nuget.org/account/trustedpublishing
  #     - name: Push NuGet
  #       run: |
  #         dotnet nuget push ./NuGet/*.nupkg --source https://api.nuget.org/v3/index.json --api-key ${{steps.login.outputs.NUGET_API_KEY}}